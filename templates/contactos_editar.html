{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4>Editar Contacto: {{ contacto.nombre }}</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('editar_contacto', id=contacto.id) }}">

                    <div class="row mb-3 align-items-end">
                        <div class="col-md-8">
                            <label class="form-label">Empresa</label>
                            <select name="empresa_id" class="form-select" required>
                                {% for empresa in empresas %}
                                <option value="{{ empresa.id }}" {% if empresa.id== contacto.empresa_id %}selected{%
                                        endif %}>
                                    {{ empresa.nombre_comercial }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="contacto_principal"
                                       id="principalCheck"
                                       {% if contacto.contacto_principal %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="principalCheck">
                                    ⭐ Contacto Principal
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- In contactos_editar.html, update the nombre and apellido fields -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text"
                                   name="nombre"
                                   id="nombre"
                                   class="form-control"
                                   value="{{ contacto.nombre }}"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            <input type="text"
                                   name="apellido"
                                   id="apellido"
                                   class="form-control"
                                   value="{{ contacto.apellido }}"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Puesto</label>
                            <input type="text" name="puesto" value="{{ contacto.puesto }}" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departamento</label>
                            <input type="text" name="departamento" value="{{ contacto.departamento }}"class="form-control">
                        </div>
                    </div>

                    <!-- Add the same JavaScript validation script at the end of the template -->

                    <h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Datos de Contacto</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" value="{{ contacto.email }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono</label>
                            <!-- ADD ID HERE -->
                            <input type="text" name="telefono" id="telefono" class="form-control" value="{{ contacto.telefono }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp</label>
                            <!-- ADD ID HERE -->
                            <input type="text" name="whatsapp" id="whatsapp" class="form-control" value="{{ contacto.whatsapp }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">LinkedIn</label>
                            <input type="text" name="linkedin" class="form-control" value="{{ contacto.linkedin }}">
                        </div>
                    </div>
                    <h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Perfil Estratégico</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nivel de Decisión</label>
                            <select name="nivel_decision" class="form-select">
                                <option value="">Selecciona...</option>
                                <option value="Alto (Tomador de decisión)" {% if contacto.nivel_decision==
                                'Alto (Tomador de decisión)' %}selected{% endif %}>Alto</option>
                                <option value="Medio (Influenciador)" {% if contacto.nivel_decision==
                                'Medio (Influenciador)' %}selected{% endif %}>Medio</option>
                                <option value="Bajo (Usuario)" {% if contacto.nivel_decision==
                                'Bajo (Usuario)' %}selected{% endif %}>Bajo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Preferencia de Contacto</label>
                            <select name="preferencia_contacto" class="form-select">
                                <option value="Email" {% if contacto.preferencia_contacto==
                                'Email' %}selected{% endif %}>Email</option>
                                <option value="Llamada" {% if contacto.preferencia_contacto==
                                'Llamada' %}selected{% endif %}>Llamada</option>
                                <option value="WhatsApp" {% if contacto.preferencia_contacto==
                                'WhatsApp' %}selected{% endif %}>WhatsApp</option>
                                <option value="Reunión" {% if contacto.preferencia_contacto==
                                'Reunión' %}selected{% endif %}>Reunión</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea name="comentarios" class="form-control" rows="2">{{ contacto.comentarios }}</textarea>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const telefonoField = document.getElementById('telefono');
    const whatsappField = document.getElementById('whatsapp');

    // Initialize the flag based on the existing data
    let whatsappManuallyEdited = (whatsappField.value !== '' && whatsappField.value !== telefonoField.value);

    // When user types in the Telefono field
    telefonoField.addEventListener('input', function() {
        // Only auto-copy if the WhatsApp field hasn't been manually changed
        if (!whatsappManuallyEdited) {
            whatsappField.value = telefonoField.value;
        }
    });

    // When user types in the WhatsApp field
    whatsappField.addEventListener('input', function() {
        // If the user clears the WhatsApp field, resume auto-copying
        if (whatsappField.value === '') {
            whatsappManuallyEdited = false;
        }
        // If the user makes it different from the Telefono field, stop auto-copying
        else if (whatsappField.value !== telefonoField.value) {
            whatsappManuallyEdited = true;
        }
    });
});
</script>

{% endblock %}