{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4>Registrar Nuevo Contacto</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('crear_contacto') }}" id="contactoForm">

                    <!-- 1. Empresa and Main Contact Checkbox -->
                    <div class="row mb-3 align-items-end">
                        <div class="col-md-8">
                            <label class="form-label">Empresa Perteneciente</label>
                            <select name="empresa_id" class="form-select" required>
                                <option value="" disabled {% if not preselected_id %}selected{% endif %}>Selecciona...</option>
                                {% for empresa in empresas %}
                                    <option value="{{ empresa.id }}" {% if preselected_id and preselected_id|int == empresa.id %}selected{% endif %}>
                                        {{ empresa.nombre_comercial }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="contacto_principal" id="principalCheck">
                                <label class="form-check-label fw-bold" for="principalCheck">
                                    ⭐ Contacto Principal
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Basic Info WITH VALIDATION -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text"
                                   name="nombre"
                                   id="nombre"
                                   class="form-control"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            <input type="text"
                                   name="apellido"
                                   id="apellido"
                                   class="form-control"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                    </div>

                    <!-- ... REST OF YOUR EXISTING FIELDS ... -->

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Puesto</label>
                            <input type="text" name="puesto" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departamento</label>
                            <input type="text" name="departamento" class="form-control">
                        </div>
                    </div>

                    <!-- 3. Contact Details -->
                    <h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Datos de Contacto</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono (Oficina)</label>
                            <input type="text" name="telefono" class="form-control">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp (Móvil)</label>
                            <input type="text" name="whatsapp" class="form-control" placeholder="+52...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">LinkedIn URL</label>
                            <input type="text" name="linkedin" class="form-control" placeholder="https://linkedin.com/in/...">
                        </div>
                    </div>

                    <!-- 4. Strategic Info -->
                    <h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Perfil Estratégico</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nivel de Decisión</label>
                            <select name="nivel_decision" class="form-select">
                                <option value="">Selecciona...</option>
                                <option value="Alto (Tomador de decisión)">Alto (Tomador de decisión)</option>
                                <option value="Medio (Influenciador)">Medio (Influenciador)</option>
                                <option value="Bajo (Usuario)">Bajo (Usuario)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Preferencia de Contacto</label>
                            <select name="preferencia_contacto" class="form-select">
                                <option value="Email">Email</option>
                                <option value="Llamada">Llamada</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Reunión">Reunión Presencial</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea name="comentarios" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">Guardar Contacto</button>
                        <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT VALIDATION -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the name fields
    const nombreField = document.getElementById('nombre');
    const apellidoField = document.getElementById('apellido');
    const form = document.getElementById('contactoForm');

    // Allowed characters: letters, spaces, hyphen, apostrophe
    // Including Spanish accented characters
    const allowedPattern = /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']*$/;

    // Function to validate a field
    function validateNameField(field) {
        const value = field.value;

        if (!allowedPattern.test(value)) {
            field.classList.add('is-invalid');
            return false;
        } else {
            field.classList.remove('is-invalid');
            return true;
        }
    }

    // Real-time validation for Nombre
    nombreField.addEventListener('input', function(e) {
        const currentValue = e.target.value;
        const lastChar = currentValue[currentValue.length - 1];

        // If the last character typed is invalid, remove it
        if (lastChar && !allowedPattern.test(lastChar)) {
            e.target.value = currentValue.slice(0, -1);

            // Show error briefly
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }
    });

    // Real-time validation for Apellido
    apellidoField.addEventListener('input', function(e) {
        const currentValue = e.target.value;
        const lastChar = currentValue[currentValue.length - 1];

        // If the last character typed is invalid, remove it
        if (lastChar && !allowedPattern.test(lastChar)) {
            e.target.value = currentValue.slice(0, -1);

            // Show error briefly
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }
    });

    // Prevent paste of invalid content
    function handlePaste(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const cleanedText = pastedText.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']/g, '');

        if (cleanedText !== pastedText) {
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }

        // Insert only the cleaned text
        document.execCommand('insertText', false, cleanedText);
    }

    nombreField.addEventListener('paste', handlePaste);
    apellidoField.addEventListener('paste', handlePaste);

    // Validate on form submit
    form.addEventListener('submit', function(e) {
        const nombreValid = validateNameField(nombreField);
        const apellidoValid = validateNameField(apellidoField);

        if (!nombreValid || !apellidoValid) {
            e.preventDefault();

            // Focus on the first invalid field
            if (!nombreValid) {
                nombreField.focus();
            } else if (!apellidoValid) {
                apellidoField.focus();
            }
        }
    });
});
</script>

{% endblock %}