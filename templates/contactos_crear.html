{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4>Registrar Nuevo Contacto</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('crear_contacto') }}" id="contactoForm">

                    <!-- 1. Empresa and Main Contact Checkbox -->
                    <div class="row mb-3 align-items-end">
                        <div class="col-md-8">
                            <label class="form-label">Empresa Perteneciente</label>
                            <select name="empresa_id" class="form-select" required>
                                <option value="" disabled {% if not preselected_id %}selected{% endif %}>Selecciona...</option>
                                {% for empresa in empresas %}
                                    <option value="{{ empresa.id }}" {% if preselected_id and preselected_id|int == empresa.id %}selected{% endif %}>
                                        {{ empresa.nombre_comercial }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="contacto_principal" id="principalCheck">
                                <label class="form-check-label fw-bold" for="principalCheck">
                                    ⭐ Contacto Principal
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Basic Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            <input type="text"
                                   name="nombre"
                                   id="nombre"
                                   class="form-control"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            <input type="text"
                                   name="apellido"
                                   id="apellido"
                                   class="form-control"
                                   required
                                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']+"
                                   title="Solo se permiten letras, espacios, guiones y apostrofes">
                            <div class="invalid-feedback">
                                Solo se permiten letras, espacios, guiones (-) y apostrofes (')
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Puesto</label>
                            <input type="text" name="puesto" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Departamento</label>
                            <input type="text" name="departamento" class="form-control">
                        </div>
                    </div>

                    <!-- 3. Contact Details WITH AUTO-POPULATE -->
                    <h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Datos de Contacto</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Teléfono (Oficina)</label>
                            <!-- Added ID for JavaScript reference -->
                            <input type="text" name="telefono" id="telefono" class="form-control">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">WhatsApp (Móvil)</label>
                            <!-- Added ID for JavaScript reference -->
                            <input type="text" name="whatsapp" id="whatsapp" class="form-control" placeholder="+52...">
                            <small class="text-muted">Se auto-completa con el teléfono. Puedes editarlo si es diferente.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">LinkedIn URL</label>
                            <input type="text" name="linkedin" class="form-control" placeholder="https://linkedin.com/in/...">
                        </div>
                    </div>

                    <!-- ... REST OF THE FORM REMAINS THE SAME ... -->

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">Guardar Contacto</button>
                        <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT VALIDATION AND AUTO-POPULATE -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== NAME VALIDATION =====
    const nombreField = document.getElementById('nombre');
    const apellidoField = document.getElementById('apellido');
    const form = document.getElementById('contactoForm');

    const allowedPattern = /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']*$/;

    function validateNameField(field) {
        const value = field.value;
        if (!allowedPattern.test(value)) {
            field.classList.add('is-invalid');
            return false;
        } else {
            field.classList.remove('is-invalid');
            return true;
        }
    }

    // Real-time validation for Nombre
    nombreField.addEventListener('input', function(e) {
        const currentValue = e.target.value;
        const lastChar = currentValue[currentValue.length - 1];

        if (lastChar && !allowedPattern.test(lastChar)) {
            e.target.value = currentValue.slice(0, -1);
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }
    });

    // Real-time validation for Apellido
    apellidoField.addEventListener('input', function(e) {
        const currentValue = e.target.value;
        const lastChar = currentValue[currentValue.length - 1];

        if (lastChar && !allowedPattern.test(lastChar)) {
            e.target.value = currentValue.slice(0, -1);
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }
    });

    // Prevent paste of invalid content
    function handlePaste(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const cleanedText = pastedText.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s\-']/g, '');

        if (cleanedText !== pastedText) {
            e.target.classList.add('is-invalid');
            setTimeout(() => {
                e.target.classList.remove('is-invalid');
            }, 2000);
        }

        document.execCommand('insertText', false, cleanedText);
    }

    nombreField.addEventListener('paste', handlePaste);
    apellidoField.addEventListener('paste', handlePaste);

    // ===== AUTO-POPULATE WHATSAPP FROM TELEFONO =====
    const telefonoField = document.getElementById('telefono');
    const whatsappField = document.getElementById('whatsapp');

    // Track if user has manually edited whatsapp
    let whatsappManuallyEdited = false;

    // When user types in telefono
    telefonoField.addEventListener('input', function() {
        // Only auto-copy if user hasn't manually edited whatsapp
        if (!whatsappManuallyEdited) {
            whatsappField.value = telefonoField.value;
        }
    });

    // When user manually types in whatsapp
    whatsappField.addEventListener('input', function() {
        // Check if it's different from telefono to detect manual edit
        if (whatsappField.value !== telefonoField.value) {
            whatsappManuallyEdited = true;
        }
    });

    // Reset the flag if user clears whatsapp
    whatsappField.addEventListener('change', function() {
        if (whatsappField.value === '') {
            whatsappManuallyEdited = false;
        }
    });

    // Validate on form submit
    form.addEventListener('submit', function(e) {
        const nombreValid = validateNameField(nombreField);
        const apellidoValid = validateNameField(apellidoField);

        if (!nombreValid || !apellidoValid) {
            e.preventDefault();

            if (!nombreValid) {
                nombreField.focus();
            } else if (!apellidoValid) {
                apellidoField.focus();
            }
        }
    });
});
</script>

{% endblock %}